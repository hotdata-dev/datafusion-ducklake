# Delete Filter Tests

This directory contains comprehensive tests for the delete file filtering functionality in datafusion-ducklake.

## Test Coverage

### Unit Tests
- `test_extract_deleted_positions_simple` - Basic delete file batch structure
- `test_extract_deleted_positions_multiple_files` - Multiple files handling
- `test_extract_deleted_positions_with_nulls` - Null value handling

### Integration Tests
- `test_table_without_delete_files` - Backward compatibility
- `test_table_with_delete_files` - Delete filtering
- `test_deleted_rows_excluded` - Row exclusion verification
- `test_empty_result_with_all_deleted` - Empty result sets
- `test_updated_rows_show_new_values` - UPDATE operations (DELETE + INSERT)
- `test_count_with_deletes` - COUNT aggregations
- `test_aggregation_with_deletes` - Aggregations with deletes

## Running Tests

### Prerequisites

1. Install DuckDB CLI: https://duckdb.org/docs/installation/

2. Generate test data (only needed once, or after cleaning):
   ```bash
   ./tests/generate_test_data.sh
   ```

   Or manually:
   ```bash
   duckdb < tests/setup_test_data_v2.sql
   ```

### Run Tests

```bash
# Run all delete filter tests
cargo test --test delete_filter_tests

# Run with output
cargo test --test delete_filter_tests -- --nocapture

# Run a specific test
cargo test --test delete_filter_tests test_table_with_delete_files

# Run unit tests only
cargo test --test delete_filter_tests unit_tests::
```

## Test Data

The test data is generated by `setup_test_data_v2.sql` and creates three DuckLake databases:

1. **no_deletes.ducklake** - Table without delete files (backward compatibility testing)
   - 4 users with no deletions

2. **with_deletes.ducklake** - Table with DELETE operations
   - 5 products initially, 2 deleted (IDs 2 and 4)
   - Expected result: 3 products (IDs 1, 3, 5)

3. **with_updates.ducklake** - Table with UPDATE operations
   - 3 inventory items, 2 updated (IDs 1 and 3)
   - Tests that old versions are hidden and new versions are visible

### Data Location

All test data is generated in `tests/test_data/` and is gitignored (not committed to the repository).

## Troubleshooting

### "Test data not found" message

If you see this message when running tests, generate the test data:
```bash
./tests/generate_test_data.sh
```

### Tests fail with "file not found"

Make sure you've run the test data generation script and that DuckDB created all the necessary files.

### Clean and regenerate

To clean and regenerate all test data:
```bash
rm -rf tests/test_data/
./tests/generate_test_data.sh
cargo test --test delete_filter_tests
```
